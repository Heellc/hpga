name: main
on:
  workflow_dispatch:
jobs:
  Main:
    runs-on: ubuntu-latest
    steps:
      - name: Run next action
        run: |
          (sleep 5h 50m && \
          curl -X POST -H "Accept: application/vnd.github.v3+json" -H "Authorization: token $TOKEN" \
          https://api.github.com/repos/Heellc/hpga/actions/workflows/main.yml/dispatches -d '{"ref":"main"}') &
        env:
          TOKEN: ${{ secrets.TOKEN }}
      - name: Download frpc
        run: |
          wget https://github.com/fatedier/frp/releases/download/v0.36.2/frp_0.36.2_linux_amd64.tar.gz
          tar -zxf ./frp_0.36.2_linux_amd64.tar.gz
          mv ./frp_0.36.2_linux_amd64/frpc ./frpc
          chmod +x ./frpc
      - name: Write Public key
        run: |
          echo $PUBKEY > ./id_rsa.pub
        env:
          PUBKEY: ${{ secrets.PUBKEY }}
      - name: Write frp ini
        run: |
          echo "
          
          
          [common]
          server_addr = $IP
          server_port = $PORT
          privilege_token = $TOKEN
          tls_enable = true
          tls_key_file = ./id_rsa.pub
          login_fail_exit = false
          log_file = console
          
          [proxy]
          type = tcp
          plugin = http_proxy
          remote_port = 11080
          
          
          " > frpc.ini
        env: 
          TOKEN: ${{ secrets.TOKEN }}
          IP: ${{ secrets.IP }}
          PORT: ${{ secrets.PORT }}
      - name: Start frp
        run: ./frpc -c ./frpc.ini
